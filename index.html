<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Tracker - SPA</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /* Reset and base */
    * {
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      color: #2c3e50;
      background: linear-gradient(135deg, #667eea, #764ba2);
      animation: gradient-background 15s ease infinite;
      overflow-x: hidden;
    }

    @keyframes gradient-background {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 40px 35px 50px;
      border-radius: 18px;
      width: 90%;
      max-width: 480px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      animation: fadeIn 0.6s ease-in-out;
      display: none;
      margin-top: 20px;
      align-self: center;
    }
    .main-container {
        max-width: 650px;
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      letter-spacing: 1.2px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    h1 {
      font-size: 2.5em;
    }
    .home-greeting {
        text-align: left;
        margin-top: 0;
        margin-bottom: 10px;
        font-weight: 600;
        color: #fff;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 14px 18px;
      margin: 14px 0;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.3);
      font-size: 1.1em;
      font-weight: 500;
      color: #fff;
      box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
    }
    input[type="text"]::placeholder,
    input[type="password"]::placeholder {
      color: #e0e0e0;
    }
    input[type="text"]:focus,
    input[type="password"]:focus {
      border-color: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
      outline: none;
    }
    button {
      cursor: pointer;
      user-select: none;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      transition: all 0.3s ease;
      box-shadow: 0 6px 15px rgba(102, 126, 234, 0.6);
      color: white;
      background: linear-gradient(135deg, #667eea, #764ba2);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.9);
    }
    
    .navbar {
      width: 90%;
      max-width: 650px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 15px 30px;
      border-radius: 18px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .navbar-brand {
      font-size: 1.5em;
      font-weight: 700;
      color: #fff;
      text-decoration: none;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .navbar-links {
      display: flex;
      gap: 20px;
    }
    .navbar-link {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      font-size: 1em;
      position: relative;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .navbar-link::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 2px;
      background: #fff;
      bottom: -5px;
      left: 0;
      transform: scaleX(0);
      transform-origin: bottom right;
      transition: transform 0.3s ease;
    }
    .navbar-link:hover::after, .navbar-link.active::after {
      transform: scaleX(1);
      transform-origin: bottom left;
    }


    /* Specific buttons */
    #loginBtn, #signupBtn, #addSubjectBtn, #updateProfileBtn {
      width: 100%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 14px;
      font-size: 1.15em;
      margin-top: 25px;
    }
    #logoutBtn {
      background: #f39c12;
      box-shadow: 0 5px 15px rgba(243, 156, 18, 0.7);
      padding: 10px 22px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      border-radius: 12px;
    }
    #logoutBtn:hover {
      box-shadow: 0 8px 30px rgba(243, 156, 18, 1);
    }
    .link {
      text-align: center;
      margin-top: 18px;
      font-size: 1em;
      color: #fff;
      text-decoration: underline;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      letter-spacing: 0.7px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .subject-form {
      margin-top: 30px;
      display: flex;
      gap: 15px;
    }
    .subject-form input {
      flex-grow: 1;
      margin: 0;
    }
    .subjects {
      margin-top: 28px;
    }
    .subject {
      margin: 12px 0;
      padding: 15px 20px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(5px);
      box-shadow: 0 5px 15px rgba(118, 75, 162, 0.1);
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: box-shadow 0.3s ease;
      position: relative;
      cursor: grab;
    }
    .subject:hover {
      box-shadow: 0 10px 30px rgba(118, 75, 162, 0.15);
    }
    .subject.dragging {
      opacity: 0.5;
      transform: rotate(2deg) scale(1.05);
      box-shadow: 0 15px 30px rgba(118, 75, 162, 0.3);
      cursor: grabbing;
    }

    .subject h3 {
      margin: 0;
      font-weight: 700;
      font-size: 1.25em;
      color: #fff;
      letter-spacing: 0.7px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    .subject p {
      font-weight: 600;
      color: #e0e0e0;
      margin: 0 0 10px;
      font-size: 1em;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    /* Attendance buttons */
    .btn-group {
      display: flex;
      gap: 10px;
    }
    .btn-attendance {
      width: 36px;
      height: 36px;
      font-size: 24px;
      line-height: 0;
      padding: 0;
      border-radius: 50%;
      font-weight: 700;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      color: white;
    }
    .btn-attendance.present {
      background-color: #27ae60;
      box-shadow: 0 6px 12px rgba(39, 174, 96, 0.6);
    }
    .btn-attendance.present:hover {
      box-shadow: 0 10px 20px rgba(39, 174, 96, 0.85);
      transform: translateY(-2px);
    }
    .btn-attendance.absent {
      background-color: #c0392b;
      box-shadow: 0 6px 12px rgba(192, 57, 43, 0.6);
    }
    .btn-attendance.absent:hover {
      box-shadow: 0 10px 20px rgba(192, 57, 43, 0.85);
      transform: translateY(-2px);
    }
    .btn-attendance.delete {
      background-color: #7f8c8d;
      box-shadow: 0 6px 12px rgba(127, 140, 141, 0.6);
    }
    .btn-attendance.delete:hover {
      box-shadow: 0 10px 20px rgba(127, 140, 141, 0.85);
      transform: translateY(-2px);
    }
    .export-btn {
        margin-top: 20px;
        background: #3498db;
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.7);
        padding: 10px 22px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        border-radius: 12px;
    }

    /* Progress bar styles */
    .progress-container {
        width: 100%;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }
    .progress-bar {
        height: 10px;
        width: 0%;
        transition: width 0.5s ease-in-out;
    }
    .progress-bar.green { background-color: #27ae60; }
    .progress-bar.yellow { background-color: #f39c12; }
    .progress-bar.red { background-color: #c0392b; }


    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      animation: fade-in 0.3s forwards;
    }
    .modal-content {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      margin: 15% auto;
      padding: 25px;
      width: 80%;
      max-width: 400px;
      border-radius: 18px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      animation: slide-in 0.3s forwards;
    }
    .modal-content p {
      margin: 0 0 20px;
      font-size: 1.2em;
      color: #34495e;
    }
    .modal-buttons {
      display: flex;
      justify-content: space-around;
    }
    .modal-buttons button {
      padding: 10px 20px;
      margin: 0 10px;
      width: 100px;
      font-size: 1em;
      box-shadow: none;
    }
    .modal-buttons .confirm-btn {
      background: #e74c3c;
    }
    .modal-buttons .confirm-btn:hover {
      background: #c0392b;
      transform: translateY(0);
    }
    .modal-buttons .cancel-btn {
      background: #95a5a6;
    }
    .modal-buttons .cancel-btn:hover {
      background: #7f8c8d;
      transform: translateY(0);
    }

    /* Profile form specific styles */
    .profile-form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .profile-form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    /* Responsive */
    @media (max-width: 520px) {
      .container {
        padding: 30px 20px 40px;
      }
      .subject-form {
        flex-direction: column;
        gap: 0;
      }
      .subject-form input, .subject-form button {
        width: 100%;
        margin-top: 10px;
      }
      #logoutBtn {
        float: none;
        display: block;
        margin: 0 0 15px 0;
      }
      .navbar {
          padding: 10px 20px;
      }
      .navbar-brand {
          font-size: 1.2em;
      }
      .navbar-links {
          gap: 10px;
      }
      .subject .btn-group {
          flex-wrap: wrap;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slide-in {
      from { transform: translateY(-50px); }
      to { transform: translateY(0); }
    }
  </style>
</head>
<body>
  
  <!-- Single Navigation Bar to rule them all -->
  <div class="navbar" id="mainNavbar">
    <a href="#" class="navbar-brand" id="mainBrandLink">Attendance Tracker</a>
    <div class="navbar-links" id="mainNavLinks">
      <a href="#" class="navbar-link" id="homeLink" style="display: none;">Home</a>
      <a href="#" class="navbar-link" id="profileLink" style="display: none;">Profile</a>
      <a href="#" class="navbar-link" id="aboutLink">About</a>
      <a href="#" class="navbar-link" id="contactLink">Contact Us</a>
      <button id="logoutBtn" style="display: none;">Logout</button>
    </div>
  </div>

  <!-- LOGIN VIEW -->
  <div class="container" id="loginView" style="display: block;">
    <h2>Login</h2>
    <input type="text" id="loginEmail" placeholder="Email" autocomplete="username" />
    <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>
    <div class="link" id="goToSignup">New user? Sign Up</div>
  </div>

  <!-- SIGNUP VIEW -->
  <div class="container" id="signupView">
    <h2>Sign Up</h2>
    <input type="text" id="signupEmail" placeholder="Email" autocomplete="username" />
    <input type="password" id="signupPassword" placeholder="Password" autocomplete="new-password" />
    <button id="signupBtn">Register</button>
    <div class="link" id="goToLogin">Already have an account? Login</div>
  </div>
  
  <!-- HOME VIEW - Displayed after login -->
  <div class="container main-container" id="homeView">
    <h2 class="home-greeting">Welcome, <span id="userName"></span>!</h2>
    <h1>Your Subjects</h1>
    <div class="subject-form">
      <input type="text" id="subjectInput" placeholder="Enter subject name" />
      <button id="addSubjectBtn">Add Subject</button>
    </div>
    <div class="subjects" id="subjects"></div>
    <button id="exportDataBtn" class="export-btn">Export as CSV</button>
  </div>

  <!-- PROFILE VIEW -->
  <div class="container" id="profileView">
      <h2>Edit Profile</h2>
      <div class="profile-form-group">
        <label for="profileName">Name:</label>
        <input type="text" id="profileName" placeholder="Enter your name" />
      </div>
      <div class="profile-form-group">
        <label for="profileEmail">Email:</label>
        <input type="text" id="profileEmail" disabled />
      </div>
      <div class="profile-form-group">
        <label for="profilePassword">New Password:</label>
        <input type="password" id="profilePassword" placeholder="Leave blank to keep current password" />
      </div>
      <button id="updateProfileBtn">Save Changes</button>
  </div>

  <!-- ABOUT VIEW -->
  <div class="container" id="aboutView">
    <h1>About Attendance Tracker</h1>
    <p>This is a simple single-page application to help you track your attendance for various subjects. Log in to your account and your data will be automatically synced across all your devices.</p>
    <p>Feel free to add new subjects, mark your attendance, and keep an eye on your attendance percentage to make sure you're on track!</p>
    <p>This application is powered by Firebase for secure user authentication and real-time data storage.</p>
  </div>

  <!-- CONTACT VIEW -->
  <div class="container" id="contactView">
    <h1>Contact Us</h1>
    <p>If you have any questions, feedback, or issues, please don't hesitate to reach out to us.</p>
    <p><strong>Email:</strong> support@attendancetracker.com</p>
    <p><strong>Phone:</strong> +1 (555) 123-4567</p>
    <p>We aim to respond to all inquiries within 48 hours.</p>
  </div>

  <!-- Custom Modal for Alerts/Confirmations -->
  <div id="customModal" class="modal">
    <div class="modal-content">
      <p id="modalMessage"></p>
      <div class="modal-buttons">
        <button id="modalConfirmBtn" class="confirm-btn" style="display:none;">OK</button>
        <button id="modalCancelBtn" class="cancel-btn" style="display:none;">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      updateProfile,
      updatePassword
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";


    // --- Firebase Initialization ---
    // Hardcoded config as a fallback in case environment variables are not present.
    const userFirebaseConfig = {
      apiKey: "AIzaSyBIAclpFBe5yBKrnCDueWIGMybRry1petU",
      authDomain: "attendance-tracker-5ae43.firebaseapp.com",
      projectId: "attendance-tracker-5ae43",
      storageBucket: "attendance-tracker-5ae43.appspot.com",
      messagingSenderId: "710590047788",
      appId: "1:710590047788:web:45279be44a5e288d789389"
    };

    const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== ''
      ? JSON.parse(__firebase_config)
      : userFirebaseConfig;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;
    let subjects = [];

    // --- Custom Modal Functions (replaces alert and confirm) ---
    function showAlert(message) {
      return new Promise(resolve => {
        const modal = document.getElementById('customModal');
        const messageElem = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        messageElem.textContent = message;
        confirmBtn.textContent = 'OK';
        confirmBtn.style.display = 'block';
        cancelBtn.style.display = 'none';

        const handleConfirm = () => {
          modal.style.display = 'none';
          confirmBtn.removeEventListener('click', handleConfirm);
          resolve(true);
        };

        confirmBtn.addEventListener('click', handleConfirm);
        modal.style.display = 'block';
      });
    }

    function showConfirm(message) {
      return new Promise(resolve => {
        const modal = document.getElementById('customModal');
        const messageElem = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        messageElem.textContent = message;
        confirmBtn.textContent = 'Yes';
        cancelBtn.textContent = 'No';
        confirmBtn.style.display = 'block';
        cancelBtn.style.display = 'block';

        const handleConfirm = () => {
          modal.style.display = 'none';
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
          resolve(true);
        };

        const handleCancel = () => {
          modal.style.display = 'none';
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
          resolve(false);
        };

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
        modal.style.display = 'block';
      });
    }
    
    function showPrompt(message, defaultValue = '') {
      return new Promise(resolve => {
        const input = document.createElement('input');
        input.type = 'text';
        input.value = defaultValue;
        input.style.marginTop = '10px';
        input.style.marginBottom = '20px';
        input.style.padding = '8px';
        input.style.border = '1px solid #ccc';
        input.style.borderRadius = '5px';
        input.style.width = '100%';
        input.style.color = '#000'; // Make text color dark
        input.style.backgroundColor = '#fefefe'; // Make background white
        input.focus();

        const modal = document.getElementById('customModal');
        const messageElem = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        messageElem.textContent = message;
        messageElem.appendChild(input);
        confirmBtn.textContent = 'OK';
        cancelBtn.textContent = 'Cancel';
        confirmBtn.style.display = 'block';
        cancelBtn.style.display = 'block';
        
        const handleConfirm = () => {
          modal.style.display = 'none';
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
          resolve(input.value);
        };

        const handleCancel = () => {
          modal.style.display = 'none';
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
          resolve(null);
        };

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
        modal.style.display = 'block';
      });
    }

    // --- Firestore Data Functions ---
    // This function saves the current subjects array to Firestore for the logged-in user.
    async function saveSubjects() {
      if (!currentUser) return; // Don't save if no user is logged in
      try {
        const userDocRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
        await setDoc(userDocRef, { subjects: subjects }, { merge: true });
      } catch (e) {
        console.error("Error saving subjects: ", e);
        showAlert("Failed to save data. Please try again.");
      }
    }

    // This function sets up a real-time listener for the user's subjects.
    // It's the most efficient way to keep the UI in sync with the database.
    function setupRealtimeListener() {
      if (!currentUser) return;
      const userDocRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
      onSnapshot(userDocRef, (doc) => {
        if (doc.exists()) {
          subjects = doc.data().subjects || [];
        } else {
          subjects = [];
        }
        renderSubjects();
      }, (error) => {
        console.error("Error fetching real-time data: ", error);
        showAlert("Error fetching data. Please refresh.");
      });
    }


    // --- UI Rendering and Event Listeners ---
    const loginView = document.getElementById("loginView");
    const signupView = document.getElementById("signupView");
    const homeView = document.getElementById("homeView");
    const profileView = document.getElementById("profileView");
    const aboutView = document.getElementById("aboutView");
    const contactView = document.getElementById("contactView");
    const userName = document.getElementById("userName");
    
    const mainNavbar = document.getElementById("mainNavbar");
    const homeLink = document.getElementById("homeLink");
    const profileLink = document.getElementById("profileLink");
    const aboutLink = document.getElementById("aboutLink");
    const contactLink = document.getElementById("contactLink");
    const mainBrandLink = document.getElementById("mainBrandLink");
    const logoutBtn = document.getElementById("logoutBtn");

    const views = {
      login: loginView,
      signup: signupView,
      home: homeView,
      profile: profileView,
      about: aboutView,
      contact: contactView
    };

    function showView(viewName) {
      Object.values(views).forEach(view => {
        view.style.display = 'none';
      });
      views[viewName].style.display = 'block';

      // Update visibility of links based on login status and current view
      if (!currentUser) {
        homeLink.style.display = 'none';
        profileLink.style.display = 'none';
        logoutBtn.style.display = 'none';
      } else {
        homeLink.style.display = 'block';
        profileLink.style.display = 'block';
        logoutBtn.style.display = 'block';
      }
      
      // Update active state for nav links
      document.querySelectorAll('.navbar-link').forEach(link => {
        link.classList.remove('active');
      });
      if (viewName === 'home') {
          homeLink.classList.add('active');
      } else if (viewName === 'profile') {
          profileLink.classList.add('active');
      } else if (viewName === 'about') {
          aboutLink.classList.add('active');
      } else if (viewName === 'contact') {
          contactLink.classList.add('active');
      }
    }

    // Event listeners for page navigation
    mainBrandLink.addEventListener("click", (e) => {
      e.preventDefault();
      if (currentUser) {
        showView('home');
      } else {
        showView('login');
      }
    });

    homeLink.addEventListener("click", (e) => {
      e.preventDefault();
      showView('home');
    });

    profileLink.addEventListener("click", (e) => {
      e.preventDefault();
      showView('profile');
      if (currentUser) {
        document.getElementById('profileName').value = currentUser.displayName || '';
        document.getElementById('profileEmail').value = currentUser.email || '';
      }
    });

    aboutLink.addEventListener("click", (e) => {
      e.preventDefault();
      showView('about');
    });
    
    contactLink.addEventListener("click", (e) => {
        e.preventDefault();
        showView('contact');
    });

    document.getElementById("goToSignup").addEventListener("click", () => showView('signup'));
    document.getElementById("goToLogin").addEventListener("click", () => showView('login'));

    // --- Drag and Drop Logic ---
    let draggedSubject = null;
    const subjectsContainer = document.getElementById("subjects");

    subjectsContainer.addEventListener('dragstart', (e) => {
      draggedSubject = e.target;
      e.target.classList.add('dragging');
    });

    subjectsContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
      const afterElement = getDragAfterElement(subjectsContainer, e.clientY);
      const draggable = document.querySelector('.dragging');
      if (afterElement == null) {
        subjectsContainer.appendChild(draggable);
      } else {
        subjectsContainer.insertBefore(draggable, afterElement);
      }
    });

    subjectsContainer.addEventListener('drop', (e) => {
      e.preventDefault();
      const newOrder = Array.from(subjectsContainer.children).map(node => {
        const index = node.dataset.index;
        return subjects[index];
      });
      subjects = newOrder;
      saveSubjects();
      renderSubjects(); // Re-render to update data-index attributes
      if (draggedSubject) {
        draggedSubject.classList.remove('dragging');
      }
      draggedSubject = null;
    });

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.subject:not(.dragging)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }


    // Render subjects
    function renderSubjects() {
      const container = document.getElementById("subjects");
      container.innerHTML = "";
      if (subjects.length === 0) {
          container.innerHTML = "<p style='text-align:center; color: #fff; font-style: italic;'>No subjects added yet.</p>";
      }
      subjects.forEach((sub, index) => {
        const percent = sub.total > 0 ? ((sub.present / sub.total) * 100).toFixed(1) : "0";
        const status = percent >= 75 ? 'âœ…' : 'âš ï¸';
        const progressClass = percent >= 75 ? 'green' : (percent >= 50 ? 'yellow' : 'red');

        const subjectDiv = document.createElement("div");
        subjectDiv.className = "subject";
        subjectDiv.draggable = true;
        subjectDiv.dataset.index = index;

        const infoHtml = `
          <h3>${sub.name}</h3>
          <p>Present: ${sub.present} / ${sub.total} (${percent}%) ${status}</p>
          <div class="progress-container">
            <div class="progress-bar ${progressClass}" style="width: ${percent}%;"></div>
          </div>
        `;

        subjectDiv.innerHTML = infoHtml;

        // Buttons container
        const btnGroup = document.createElement("div");
        btnGroup.className = "btn-group";

        const presentBtn = document.createElement("button");
        presentBtn.className = "btn-attendance present";
        presentBtn.title = "Mark Present";
        presentBtn.textContent = "+";
        presentBtn.addEventListener("click", () => markAttendance(index, "present"));

        const absentBtn = document.createElement("button");
        absentBtn.className = "btn-attendance absent";
        absentBtn.title = "Mark Absent";
        absentBtn.textContent = "âˆ’";
        absentBtn.addEventListener("click", () => markAttendance(index, "absent"));

        const editBtn = document.createElement("button");
        editBtn.className = "btn-attendance edit";
        editBtn.title = "Edit Subject";
        editBtn.textContent = "âœŽ";
        editBtn.style.backgroundColor = "#2980b9";
        editBtn.style.boxShadow = "0 6px 12px rgba(41, 128, 185, 0.6)";
        editBtn.addEventListener("click", () => editSubject(index));

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn-attendance delete";
        deleteBtn.title = "Delete Subject";
        deleteBtn.textContent = "ðŸ—‘";
        deleteBtn.addEventListener("click", () => deleteSubject(index));

        btnGroup.appendChild(presentBtn);
        btnGroup.appendChild(absentBtn);
        btnGroup.appendChild(editBtn);
        btnGroup.appendChild(deleteBtn);
        subjectDiv.appendChild(btnGroup);
        container.appendChild(subjectDiv);
      });
    }

    // Attendance actions
    function markAttendance(index, type) {
      subjects[index].total++;
      if (type === "present") {
        subjects[index].present++;
      }
      saveSubjects();
    }

    async function editSubject(index) {
      const newName = await showPrompt("Enter new subject name:", subjects[index].name);
      if (newName && newName.trim() !== "") {
        subjects[index].name = newName.trim();
        saveSubjects();
      }
    }

    async function deleteSubject(index) {
      const result = await showConfirm(`Delete subject "${subjects[index].name}"? This cannot be undone.`);
      if (result) {
        subjects.splice(index, 1);
        saveSubjects();
      }
    }

    document.getElementById("addSubjectBtn").addEventListener("click", () => {
      const input = document.getElementById("subjectInput");
      const name = input.value.trim();
      if (name) {
        subjects.push({ name, total: 0, present: 0 });
        input.value = "";
        saveSubjects();
      } else {
        showAlert("Subject name cannot be empty.");
      }
    });

    // Export Data to CSV
    document.getElementById('exportDataBtn').addEventListener('click', () => {
      if (subjects.length === 0) {
        showAlert("No subjects to export.");
        return;
      }
      const header = "Subject,Present,Total,Percentage\n";
      const csvContent = subjects.map(s => {
        const percent = s.total > 0 ? ((s.present / s.total) * 100).toFixed(1) : "0";
        return `${s.name},${s.present},${s.total},${percent}%`;
      }).join('\n');

      const fullCsv = header + csvContent;
      const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "attendance_data.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // --- Authentication Handlers ---
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) {
        showAlert("Please enter both email and password.");
        return;
      }

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged will handle the rest
      } catch (error) {
        showAlert("Login failed: " + error.message);
      }
    });

    document.getElementById("signupBtn").addEventListener("click", async () => {
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;
      if (!email || !password) {
        showAlert("Please enter both email and password.");
        return;
      }

      try {
        await createUserWithEmailAndPassword(auth, email, password);
        showAlert("Registration successful! Please login now.");
        showView('login');
      } catch (error) {
        if (error.code === "auth/email-already-in-use") {
          showAlert("This email is already registered. Try logging in instead.");
        } else {
          showAlert("Error: " + error.message);
        }
      }
    });

    // Handle Profile Updates
    document.getElementById("updateProfileBtn").addEventListener("click", async () => {
        const user = auth.currentUser;
        if (!user) {
            showAlert("You must be logged in to update your profile.");
            return;
        }

        const newName = document.getElementById('profileName').value.trim();
        const newPassword = document.getElementById('profilePassword').value;

        if (newName) {
            try {
                await updateProfile(user, { displayName: newName });
                showAlert("Profile name updated successfully!");
                userName.textContent = newName;
            } catch (error) {
                showAlert("Failed to update name: " + error.message);
            }
        }
        
        if (newPassword) {
            try {
                await updatePassword(user, newPassword);
                showAlert("Password updated successfully!");
                document.getElementById('profilePassword').value = ''; // Clear the password field
            } catch (error) {
                showAlert("Failed to update password: " + error.message);
            }
        }
    });


    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        currentUser = null;
        subjects = [];
        showView('login');
      });
    });

    // On page load, check if user is logged in
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        userName.textContent = user.displayName || user.email;
        showView('home');
        setupRealtimeListener();
      } else {
        currentUser = null;
        showView('login');
      }
    });
  </script>
</body>
</html>
